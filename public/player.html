<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>播放</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
body,html{margin:0;height:100%;background:#000}
video{width:100%;height:100%}
</style>
</head>
<body>
<video id="video" controls></video>
<script>
const qs=new URLSearchParams(location.search)
const id=qs.get('id'), idx=qs.get('idx')
if(!id) alert('缺少参数')

// 先取出该频道的原始播放地址
fetch('/api/playlist/'+id)
 .then(r=>r.json())
 .then(list=>{
   const ch=list[idx]
   if(!ch) throw '频道不存在'
   const ori=ch.url
   // 把原地址变成 /proxy/http/… 或 /proxy/https/…
   const proxy='/proxy/'+ (ori.startsWith('https://')?'https/':'http/')+ori.replace(/^https?:\/\//,'')
   play(proxy)
 })
 .catch(e=>alert(e))

function play(src){
  const video=document.getElementById('video')
  if(Hls.isSupported()){
    const hls=new Hls()
    hls.loadSource(src)
    hls.attachMedia(video)
    hls.on(Hls.Events.ERROR,(e,d)=>console.error('HLS error',d))
  }else if(video.canPlayType('application/vnd.apple.mpegurl')){
    video.src=src
  }else alert('此浏览器不支持 HLS')
}
</script>
</body>
</html>
